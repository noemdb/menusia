## üß≠ Gu√≠a Completa: Configuraci√≥n de PostgreSQL en Sistema PHP

---

### üîß Paso 1: Actualizar e Instalar PostgreSQL

```bash
# Actualizar paquetes e instalar PostgreSQL
sudo apt update && sudo apt upgrade -y
sudo apt install postgresql postgresql-contrib -y

# Verificar estado del servicio
sudo systemctl status postgresql

# Iniciar y habilitar PostgreSQL
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

---

### üîê Paso 2: Configurar Usuario `postgres`

```bash
# Acceder a la consola de PostgreSQL como usuario postgres
sudo -u postgres psql

# Opcional: Cambiar contrase√±a del usuario postgres
\password postgres

# Salir de la consola
\q
```

---

### üíæ Paso 3: Backup y Restauraci√≥n de Base de Datos

#### Crear Backup

```bash
pg_dump -h localhost -p 5432 -U postgres -F c -b -v -f "/ruta/al/backup/NombreBaseDatos.sql" NOMBRE_BASE_DATOS
```

#### Crear Nueva Base de Datos

```bash
sudo -u postgres psql

-- Crear base de datos con configuraci√≥n espec√≠fica
CREATE DATABASE "DATOS"
    WITH 
    OWNER = postgres
    TEMPLATE = template0
    ENCODING = 'SQL_ASCII'
    LC_COLLATE = 'C'
    LC_CTYPE = 'C';

\q
```

#### Restaurar Base de Datos

```bash
pg_restore -h localhost -p 5432 -U postgres -d DATOS -v "/ruta/al/respaldo/DATOS.sql"
```

> ‚ö†Ô∏è Nota: Si el archivo `.sql` es plano (no binario ni comprimido), puedes usar `psql` en lugar de `pg_restore`.

---

### üë§ Paso 4: Crear Usuario Espec√≠fico para la Aplicaci√≥n PHP

#### Script de creaci√≥n (`crear_usuario_phpapp.sh`)

```bash
#!/bin/bash

# Variables
DB_NAME="DATOS"
USER="invsia"
PASSWORD="0agi6s"

echo "Creando usuario $USER para la base de datos $DB_NAME..."

# Crear usuario
sudo -u postgres psql -c "CREATE USER $USER WITH PASSWORD '$PASSWORD';"

# Otorgar permisos en la base de datos
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $USER;"

# Otorgar permisos en esquema, tablas, secuencias y funciones
sudo -u postgres psql -d "$DB_NAME" << EOF
GRANT ALL ON SCHEMA public TO $USER;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO $USER;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO $USER;
GRANT ALL PRIVILEGES ON ALL FUNCTIONS IN SCHEMA public TO $USER;

-- Establecer permisos por defecto para objetos nuevos
ALTER DEFAULT PRIVILEGES IN SCHEMA public
    GRANT ALL ON TABLES TO $USER;
ALTER DEFAULT PRIVILEGES IN SCHEMA public
    GRANT ALL ON SEQUENCES TO $USER;
ALTER DEFAULT PRIVILEGES IN SCHEMA public
    GRANT ALL ON FUNCTIONS TO $USER;
EOF

echo "Usuario $USER creado exitosamente."
echo "Verificando creaci√≥n:"
sudo -u postgres psql -c "\du $USER"
```

#### Ejecutar el script

```bash
chmod +x crear_usuario_phpapp.sh
./crear_usuario_phpapp.sh
```

---

### ‚úÖ Paso 5: Verificaciones Post-Instalaci√≥n

```bash
# Verificar usuarios existentes
sudo -u postgres psql -c "\du"

# Verificar bases de datos
sudo -u postgres psql -c "\l"

# Probar conexi√≥n con el nuevo usuario
psql -h localhost -U invsia -d DATOS -c "SELECT current_user;"
```

---

### üìÇ Paso 6: Actualizar Configuraci√≥n PHP

Aseg√∫rate de actualizar el archivo de configuraci√≥n de la aplicaci√≥n PHP con los siguientes valores:

```php
'db_host' => 'localhost',
'db_port' => '5432',
'db_name' => 'DATOS',
'db_user' => 'invsia',
'db_pass' => '0agi6s',
```

---

### üîÑ Comandos Adicionales √ötiles

```bash
# Crear usuario (con un solo comando)
sudo -u postgres psql -c "CREATE USER usia WITH PASSWORD 'super';"
sudo -u postgres psql -c 'GRANT ALL PRIVILEGES ON DATABASE "DATOS" TO usia;'
sudo -u postgres psql -d "DATOS" -c "
GRANT ALL ON SCHEMA public TO usia;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO usia;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO usia;
GRANT ALL PRIVILEGES ON ALL FUNCTIONS IN SCHEMA public TO usia;"
```

